<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freilifts - Exercise Log</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#343a40"/>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="auth-container">
        <div class="card auth-card">
            <form id="login-form">
                <h2>Login to Freilifts</h2>
                <div class="form-group">
                    <label for="login-name">Name</label>
                    <input type="text" id="login-name" required>
                </div>
                <div class="form-group">
                    <label for="login-pin">PIN (4-8 characters)</label>
                    <input type="password" id="login-pin" required minlength="4" maxlength="8">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Login</button>
                    <button type="button" id="show-register-btn" class="btn-secondary">Register</button>
                </div>
            </form>
            <form id="register-form" style="display: none;">
                <h2>Register for Freilifts</h2>
                <div class="form-group">
                    <label for="register-name">Name</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label for="register-pin">PIN (4-8 characters)</label>
                    <input type="password" id="register-pin" required minlength="4" maxlength="8">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Register</button>
                    <button type="button" id="show-login-btn" class="btn-secondary">Login</button>
                </div>
            </form>
            <p id="auth-error" class="auth-error"></p>
        </div>
    </div>
    <!-- Main App Container -->
    <div id="app-container" style="display: none;">
        <header>
            <div class="header-controls">
                <div id="user-info">
                    <span id="user-name-display"></span>
                </div>
                <!-- NEW: Settings Menu Structure -->
                <div class="settings-menu">
                    <button id="settings-menu-btn" class="icon-btn" title="Settings">&#9776;</button>
                    <div id="settings-dropdown" class="dropdown-content" style="display: none;">
                        <button class="tab-button dropdown-item" data-tab="tab-manage-exercises">Manage Exercises</button>
                        <button class="tab-button dropdown-item" data-tab="tab-about-me">About Me</button>
                        <button class="tab-button dropdown-item" id="admin-users-tab-btn" data-tab="tab-users" style="display: none;">Users</button>
                        <hr>
                        <div class="theme-switcher-container dropdown-item">
                            <label for="theme-switcher">Theme:</label>
                            <select id="theme-switcher">
                                <option value="theme-light">Light</option>
                                <option value="theme-dark">Dark</option>
                                <option value="theme-matrix">Matrix</option>
			        <option value="theme-high-contrast">High Contrast</option>
                            </select>
                        </div>
                        <hr>
                        <button id="logout-btn" class="dropdown-item">Logout</button>
                    </div>
                </div>
            </div>
            <h1>Freilifts</h1>
            <!-- Main navigation bar is now cleaner -->
            <nav id="tab-nav">
                <button class="tab-button" data-tab="tab-workout-log">Workout Log</button>
                <button class="tab-button" data-tab="tab-food-log">Food Log</button>
                <button class="tab-button" data-tab="tab-programs">Programs</button>
                <button class="tab-button" data-tab="tab-personal-records">Personal Records</button>
                <button class="tab-button" data-tab="tab-my-progress">My Progress</button>
            </nav>
        </header>
        <main>
            <div id="tab-workout-log" class="tab-content">
                <div class="workout-log-layout">
                    <div class="workout-main-panel">
                        <section id="create-workout-section" class="card">
                            <h3>Create a Workout Log</h3>
                            <div id="workout-calendar-container">
                                <div class="calendar-header">
                                    <button id="calendar-prev-week" class="nav-arrow" title="Previous Week">&#9664;</button>
                                    <h4 id="calendar-month-year"></h4>
                                    <button id="calendar-next-week" class="nav-arrow" title="Next Week">&#9654;</button>
                                </div>
                                <div class="calendar-days-header">
                                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                                </div>
                                <div id="calendar-days-grid" class="calendar-days-grid">
                                </div>
                            </div>
                            <form id="create-workout-form" novalidate>
                                <div class="form-inline-group">
                                    <div class="form-group" style="display: none;">
                                        <label for="workout-date">Date</label>
                                        <input type="date" id="workout-date" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="workout-bodyweight">Body Weight (lbs)</label>
                                        <input type="number" id="workout-bodyweight" step="0.1" placeholder="e.g., 185.5">
                                    </div>
                                    <div class="form-group">
                                        <label for="workout-category">Workout Type</label>
                                        <select id="workout-category"></select>
                                    </div>
                                    <button type="button" id="start-workout-btn" class="btn-primary">Start Workout</button>
                                </div>
                            </form>
                        </section>
                        <section id="current-workout-section" class="card" style="display: none;">
                            <div class="workout-header">
                                <button id="prev-workout-btn" class="nav-arrow" title="Previous Workout">&#9664;</button>
                                <div class="workout-title-group">
                                    <h3 id="workout-title"></h3>
                                    <div id="workout-timer-display" style="display: none;">
                                        &#9201; <span>00:00:00</span>
                                    </div>
                                    <div id="bodyweight-display-container" class="bodyweight-display">
                                        <strong>Body Weight:</strong>
                                        <span id="bodyweight-value"></span> lbs
                                        <button id="edit-bodyweight-btn" class="icon-btn edit" title="Edit Body Weight">&#9998;</button>
                                    </div>
                                </div>
                                <div class="workout-header-actions">
                                    <button id="edit-workout-btn" class="icon-btn edit" title="Edit Workout">&#9998;</button>
                                    <button id="delete-workout-btn" class="icon-btn delete" title="Delete this workout">&#128465;</button>
                                    <button id="next-workout-btn" class="nav-arrow" title="Next Workout">&#9654;</button>
                                </div>
                            </div>
                            <!-- The old static form is removed, this div is the target for dynamic rendering -->
                            <div id="workout-log-entries"></div>
                            <div id="workout-exercise-search-results" class="search-results-container" style="display: none;"></div>
                            <div id="workout-controls" class="workout-controls">
                                <button id="finish-workout-btn" class="btn-primary">Finish Workout</button>
                            </div>
                        </section>
                    </div>
                    <div class="workout-summary-panel">
                        <section class="card">
                            <h3>Last Workout Summary</h3>
                            <div class="form-group">
                                <label for="summary-category-select">View last workout for:</label>
                                <select id="summary-category-select"></select>
                            </div>
                            <div id="workout-summary-content">
                                <p>Select a category to see the last workout.</p>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <div id="tab-manage-exercises" class="tab-content">
                <h2>Manage Exercises</h2>
                <section class="card">
    <h3>Add New Exercise</h3>
    <form id="add-exercise-form">
        <div class="form-row">
            <div class="form-group" style="flex-grow: 2;">
                <label for="new-exercise-name">Exercise Name</label>
                <input type="text" id="new-exercise-name" placeholder="e.g., Bench Press" required>
            </div>
            <div class="form-group">
                <label for="new-exercise-primary">Primary Muscle</label>
                <input type="text" id="new-exercise-primary" list="muscle-list-data" placeholder="e.g., Chest" required>
            </div>
        </div>
        <div class="form-group">
            <label for="new-exercise-secondary">Secondary Muscles (comma-separated)</label>
            <input type="text" id="new-exercise-secondary" placeholder="e.g., Shoulders, Triceps">
        </div>
        <div class="form-actions">
            <button type="submit" class="btn-primary">Add Exercise</button>
            <button type="button" id="import-csv-btn" class="btn-secondary" title="Import a CSV file with 'name,primaryMuscle,secondaryMuscles' headers.">
                Import CSV
            </button>
            <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
        </div>
    </form>
</section>

<section class="card">
    <h3>Your Exercise Library</h3>
    <div id="exercise-list-container">
        <!-- The new exercise list/table will be rendered here -->
    </div>
</section>
            </div>
            <div id="tab-food-log" class="tab-content">
                <section id="create-food-log-section" class="card">
                    <h3>Log Food for a Day</h3>
                    <div id="food-calendar-container">
                        <div class="calendar-header">
                            <button id="food-calendar-prev-week" class="nav-arrow" title="Previous Week">&#9664;</button>
                            <h4 id="food-calendar-month-year"></h4>
                            <button id="food-calendar-next-week" class="nav-arrow" title="Next Week">&#9654;</button>
                        </div>
                        <div class="calendar-days-header">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="food-calendar-days-grid" class="calendar-days-grid">
                        </div>
                    </div>
                    <form id="create-food-log-form">
                        <div class="form-group" style="display: none;">
                            <label for="food-log-date">Date</label>
                            <input type="date" id="food-log-date" required>
                        </div>
                        <button type="submit" class="btn-primary">Start Food Log</button>
                    </form>
                </section>
                <section id="current-food-log-section" class="card" style="display: none;">
                    <div class="workout-header">
                        <button id="prev-food-log-btn" class="nav-arrow" title="Previous Day">&#9664;</button>
                        <div class="workout-title-group">
                            <h3 id="food-log-title"></h3>
                        </div>
                        <div class="workout-header-actions">
                            <button id="edit-food-log-btn" class="icon-btn edit" title="Edit Day's Log">&#9998;</button>
                            <button id="delete-food-log-btn" class="icon-btn delete" title="Delete Day's Log">&#128465;</button>
                            <button id="next-food-log-btn" class="nav-arrow" title="Next Day">&#9654;</button>
                        </div>
                    </div>
                    <form id="add-food-item-form">
                        <div class="log-inputs">
                            <div class="form-group input-with-icon" style="flex-grow: 2;">
                                <label for="food-item-name">Search, Enter UPC, or Scan</label>
                                <input type="text" id="food-item-name" placeholder="e.g., Chicken Breast or barcode" required autocomplete="off">
                                <button type="button" id="scan-barcode-btn" class="icon-btn" title="Scan Barcode"></button>
                                <div id="food-search-results-container"></div>
                            </div>
                            <div class="form-group">
                                 <label for="food-item-meal">Meal</label>
                                <select id="food-item-meal">
                                    <option>Breakfast</option>
                                    <option>Lunch</option>
                                    <option>Dinner</option>
                                    <option>Snack</option>
                                </select>
                            </div>
                        </div>
                        <div id="food-macro-details" class="log-inputs">
                             <div class="form-group">
                                <label for="food-item-quantity">Quantity</label>
                                <input type="number" id="food-item-quantity" step="0.1" value="1" required>
                            </div>
                             <div class="form-group">
                                <label for="food-item-unit">Unit</label>
                                <select id="food-item-unit"></select>
                            </div>
                            <div class="form-group">
                                <label for="food-item-fat">Fat (g)</label>
                                <input type="number" id="food-item-fat" step="0.1" placeholder="0" required>
                            </div>
                            <div class="form-group">
                                <label for="food-item-carbs">Carbs (g)</label>
                                <input type="number" id="food-item-carbs" step="0.1" placeholder="0" required>
                            </div>
                            <div class="form-group">
                                <label for="food-item-protein">Protein (g)</label>
                                <input type="number" id="food-item-protein" step="0.1" placeholder="0" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Add Food</button>
                            <button type="button" id="show-custom-food-modal-btn" class="btn-secondary">New Custom Food</button>
                        </div>
                    </form>
                    <div class="food-log-display-layout">
                        <div id="food-log-entries"></div>
                        <div class="totals-display">
                            <h3>Daily Totals</h3>
                            <div id="calorie-goal-progress"></div>
                            <p id="food-log-totals"></p>
                            <div class="chart-container">
                                 <canvas id="macro-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="workout-controls">
                        <button id="finish-food-log-btn" class="btn-primary">Done Eating</button>
                    </div>
                </section>
            </div>
            <div id="tab-personal-records" class="tab-content">
                <h2>Personal Records</h2>
                <p>This table shows the heaviest weight logged for each exercise.</p>
                <div id="pr-container" class="pr-layout"></div>
            </div>
            <div id="tab-my-progress" class="tab-content">
                <h2>My Progress</h2>
	    <section id="weekly-summary-section">
    <div class="weekly-nav-header">
        <button id="week-nav-prev" class="nav-arrow" title="Previous Week">&#9664;</button>
        <h3 id="week-display">This Week</h3>
        <button id="week-nav-next" class="nav-arrow" title="Next Week" disabled>&#9654;</button>
    </div>
    <div class="weekly-summary-grid">
        <div id="weekly-set-volume-card" class="card">
            <h4>Set Volume by Muscle</h4>
            <div id="set-volume-list"></div>
        </div>
        <div id="weekly-nutrition-card" class="card">
            <h4>Average Daily Nutrition</h4>
            <div id="nutrition-summary-list"></div>
        </div>
    </div>
</section>
                <p>Use your mouse wheel to zoom and click-and-drag to pan the charts.</p>
                <div class="progress-charts-layout">
                    <div class="card">
                        <h3>Calories Over Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="calories-chart"></canvas>
                            <button class="reset-zoom-btn" data-chart-id="calories-chart">Reset Zoom</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Protein Over Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="protein-chart"></canvas>
                            <button class="reset-zoom-btn" data-chart-id="protein-chart">Reset Zoom</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Body Weight Over Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="weight-chart"></canvas>
                            <button class="reset-zoom-btn" data-chart-id="weight-chart">Reset Zoom</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-about-me" class="tab-content">
                <h2>About Me</h2>
                <div class="about-me-layout">
                    <section class="card">
                        <div class="card-header-with-action">
                            <h3>Your Information</h3>
                            <button type="button" id="edit-about-me-btn" class="icon-btn edit" title="Edit Information" style="display: none;">&#9998;</button>
                        </div>
                        <form id="about-me-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="about-sex">Sex</label>
                                    <select id="about-sex">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="about-age">Age</label>
                                    <input type="number" id="about-age" placeholder="e.g., 30" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="about-height">Height (inches)</label>
                                <input type="number" id="about-height" placeholder="e.g., 70" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="about-start-weight">Current Weight (lbs)</label>
                                    <input type="number" id="about-start-weight" step="0.1" placeholder="e.g., 195.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="about-goal-weight">Goal Weight (lbs)</label>
                                    <input type="number" id="about-goal-weight" step="0.1" placeholder="e.g., 180.0" required>
                                </div>
                            </div>
                             <div class="form-group">
                                <label for="about-activity-level">Activity Level</label>
                                <select id="about-activity-level">
                                    <option value="1.2">Sedentary (little or no exercise)</option>
                                    <option value="1.375">Lightly Active (light exercise/sports 1-3 days/week)</option>
                                    <option value="1.55" selected>Moderately Active (moderate exercise/sports 3-5 days/week)</option>
                                    <option value="1.725">Very Active (hard exercise/sports 6-7 days a week)</option>
                                    <option value="1.9">Extra Active (very hard exercise/physical job)</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="submit" id="save-about-me-btn" class="btn-primary">Save & Calculate</button>
                            </div>
                        </form>
                    </section>
                    <section class="card">
                        <h3>Advanced Options</h3>
                        <p>If you've taken a break and your current weight is higher than past entries, your calorie goals may be too low. Resetting will make the app ignore all past bodyweight entries for goal calculations.</p>
                        <div class="form-actions">
                            <button type="button" id="reset-weight-history-btn" class="btn-secondary">Reset Weight History</button>
                        </div>
                    </section>
                    <section class="card">
                        <h3>Calorie & Macro Goals</h3>
                        <div id="calorie-results-container">
                            <p>Fill out and save your information to calculate your goals.</p>
                        </div>
                    </section>
                </div>
            </div>
            <div id="tab-users" class="tab-content">
                <h2>User Management</h2>
                <div class="card">
                    <h3>All Users</h3>
                    <div id="user-list-container">
                        <p>Loading user data...</p>
                    </div>
                </div>
            </div>
            <div id="tab-programs" class="tab-content"></div>
	    <div id="confirmation-modal" class="modal-overlay">
	        <div class="modal-content">
	            <h3 id="confirmation-title">Are you sure?</h3>
	            <p id="confirmation-message">This action cannot be undone.</p>
	            <div class="form-actions" style="justify-content: flex-end; margin-top: 1.5rem;">
	                <button id="confirmation-cancel-btn" class="btn-secondary">Cancel</button>
	                <button id="confirmation-confirm-btn" class="btn-primary" data-danger="true">Confirm</button>
	            </div>
	        </div>
	    </div>
	    <div id="workout-selection-modal" class="modal-overlay">
    		<div class="modal-content">
        	    <h3 id="workout-selection-title">Workouts for [Date]</h3>
        	    <div id="workout-selection-list">
            <!-- JS will populate this with the day's workouts -->
        	    </div>
        	    <div class="form-actions" style="justify-content: space-between; margin-top: 1.5rem;">
            		<button id="workout-selection-close-btn" class="btn-secondary">Cancel</button>
            		<button id="workout-selection-new-btn" class="btn-primary">Start New Workout</button>
        	    </div>
    		</div>
	    </div>
        </main>
    </div>
    <datalist id="exercise-list-data"></datalist>
    <div id="scanner-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="barcode-reader"></div>
            <button id="scanner-close-btn" class="btn-secondary">Close</button>
        </div>
    </div>
    <div id="custom-food-modal" class="modal-overlay">
        <div class="modal-content">
            <form id="custom-food-form">
                <h2>New Custom Food</h2>
                <p>Define the nutrition facts for a single serving of your food.</p>
                <div class="form-group">
                    <label for="custom-food-name">Food Name</label>
                    <input type="text" id="custom-food-name" required placeholder="e.g., My Protein Powder">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="custom-serving-size">Serving Size</label>
                        <input type="number" id="custom-serving-size" required placeholder="e.g., 30">
                    </div>
                    <div class="form-group">
                        <label for="custom-serving-unit">Unit</label>
                        <input type="text" id="custom-serving-unit" value="g" readonly>
                    </div>
                </div>
                <hr>
                <p><strong>Macros per serving:</strong></p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="custom-fat">Fat (g)</label>
                        <input type="number" id="custom-fat" step="0.1" required placeholder="e.g., 2.5">
                    </div>
                    <div class="form-group">
                        <label for="custom-carbs">Carbs (g)</label>
                        <input type="number" id="custom-carbs" step="0.1" required placeholder="e.g., 5">
                    </div>
                    <div class="form-group">
                        <label for="custom-protein">Protein (g)</label>
                        <input type="number" id="custom-protein" step="0.1" required placeholder="e.g., 24">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Custom Food</button>
                    <button type="button" id="custom-food-modal-close-btn" class="btn-secondary">Cancel</button>
                </div>
                <p id="custom-food-error" class="auth-error"></p>
            </form>
        </div>
    </div>
<div id="edit-exercise-modal" class="modal-overlay">
    <div class="modal-content">
        <form id="edit-exercise-form">
            <h2>Edit Exercise</h2>
            <input type="hidden" id="edit-exercise-id">
            <div class="form-group">
                <label for="edit-exercise-name">Exercise Name</label>
                <input type="text" id="edit-exercise-name" required>
            </div>
            <div class="form-group">
                <label for="edit-exercise-primary">Primary Muscle</label>
                <input type="text" id="edit-exercise-primary" list="muscle-list-data" required>
            </div>
            <div class="form-group">
                <label for="edit-exercise-secondary">Secondary Muscles (comma-separated)</label>
                <input type="text" id="edit-exercise-secondary">
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" id="edit-exercise-cancel-btn" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- A single datalist for muscle group autocomplete -->
<datalist id="muscle-list-data"></datalist>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="predefined-exercises.js"></script>
    <script src="training-programs.js" defer></script>
    <script src="js/modules/workout.js" defer></script>
    <script src="js/modules/exercises.js" defer></script>
    <script src="js/modules/food.js" defer></script>
    <script src="js/modules/food-api.js" defer></script>
    <script src="js/modules/profile.js" defer></script>
    <script src="js/modules/progress.js" defer></script>
    <script src="js/modules/userAdmin.js" defer></script>
    <script src="js/modules/programs.js" defer></script>
    <script src="js/app.js" defer></script>
</body>
</html>